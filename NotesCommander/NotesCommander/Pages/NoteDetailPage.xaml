<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:NotesCommander.PageModels"
             xmlns:models="clr-namespace:NotesCommander.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="NotesCommander.Pages.NoteDetailPage"
             x:DataType="pageModels:NoteDetailPageModel"
             x:Name="DetailPage"
             Title="Детали заметки">

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Padding="20" Spacing="24">
                
                <!-- Заголовок -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="{Binding CurrentNote.Title}"
                           Style="{StaticResource Title1}"
                           FontSize="28" />
                    <Label Text="{Binding CurrentNote.CategoryLabel}"
                           TextColor="{StaticResource Gray400}"
                           FontSize="14" />
                    <Label Text="{Binding CurrentNote.CreatedAt, StringFormat='{0:d MMMM yyyy, HH:mm}'}"
                           TextColor="{StaticResource Gray400}"
                           FontSize="12" />
                </VerticalStackLayout>

                <!-- Фотографии -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding Photos.Count}">
                    <Label Text="Фотографии"
                           Style="{StaticResource Title3}" />
                    <CollectionView ItemsSource="{Binding Photos}"
                                    SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="12" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:VoiceNotePhoto">
                                <Border WidthRequest="200"
                                        HeightRequest="200"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="12" />
                                    </Border.StrokeShape>
                                    <Image Source="{Binding FilePath}"
                                           Aspect="AspectFill" />
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Аудио -->
                <Border Style="{StaticResource CardStyle}"
                        Padding="20">
                    <VerticalStackLayout Spacing="16">
                        <Label Text="Аудиозапись"
                               Style="{StaticResource Title3}" />
                        
                        <Grid ColumnDefinitions="Auto,*,Auto"
                              ColumnSpacing="16">
                            <Button Grid.Column="0"
                                    Text="{Binding IsPlaying, Converter={StaticResource InvertedBoolConverter}}"
                                    WidthRequest="56"
                                    HeightRequest="56"
                                    CornerRadius="28"
                                    FontSize="24"
                                    Command="{Binding ToggleAudioPlaybackCommand}">
                                <Button.Triggers>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsPlaying}" Value="True">
                                        <Setter Property="Text" Value="⏸" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Button" Binding="{Binding IsPlaying}" Value="False">
                                        <Setter Property="Text" Value="▶" />
                                    </DataTrigger>
                                </Button.Triggers>
                            </Button>
                            
                            <VerticalStackLayout Grid.Column="1"
                                                 VerticalOptions="Center"
                                                 Spacing="4">
                                <Label Text="{Binding CurrentNote.Title}"
                                       FontAttributes="Bold" />
                                <Label Text="{Binding AudioDurationDisplay}"
                                       TextColor="{StaticResource Gray400}"
                                       FontSize="12" />
                            </VerticalStackLayout>
                            
                            <Label Grid.Column="2"
                                   Text="{Binding CurrentNote.RecognitionStatusDisplay}"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary600}, Dark={StaticResource Primary200}}"
                                   FontSize="12" />
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Распознанный текст -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding CurrentNote.RecognizedText}">
                    <Label Text="Распознанный текст"
                           Style="{StaticResource Title3}" />
                    <Border Style="{StaticResource CardStyle}"
                            Padding="16">
                        <Label Text="{Binding CurrentNote.RecognizedText}"
                               LineBreakMode="WordWrap" />
                    </Border>
                </VerticalStackLayout>

                <!-- Оригинальный текст -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding CurrentNote.OriginalText}">
                    <Label Text="Оригинальный текст"
                           Style="{StaticResource Title3}" />
                    <Border Style="{StaticResource CardStyle}"
                            Padding="16">
                        <Label Text="{Binding CurrentNote.OriginalText}"
                               LineBreakMode="WordWrap" />
                    </Border>
                </VerticalStackLayout>

                <!-- Теги -->
                <VerticalStackLayout Spacing="12" IsVisible="{Binding CurrentNote.Tags.Count}">
                    <Label Text="Теги"
                           Style="{StaticResource Title3}" />
                    <FlexLayout BindableLayout.ItemsSource="{Binding CurrentNote.Tags}"
                                Wrap="Wrap"
                                AlignItems="Start"
                                JustifyContent="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:VoiceNoteTag">
                                <Border Padding="12,6"
                                        Margin="0,0,8,8"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary100}, Dark={StaticResource Primary800}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16" />
                                    </Border.StrokeShape>
                                    <Label Text="{Binding Value}"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary700}, Dark={StaticResource Primary200}}"
                                           FontSize="12" />
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </VerticalStackLayout>

                <!-- Статус синхронизации -->
                <Border Style="{StaticResource CardStyle}"
                        Padding="16">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <Label Grid.Column="0"
                               Text="Статус синхронизации"
                               VerticalOptions="Center" />
                        <Label Grid.Column="1"
                               Text="{Binding CurrentNote.SyncStatus}"
                               VerticalOptions="Center"
                               TextColor="{StaticResource Gray400}"
                               FontSize="12" />
                    </Grid>
                </Border>
                
            </VerticalStackLayout>
        </ScrollView>

        <Button Grid.Row="1"
                Text="Закрыть"
                Margin="20,0,20,24"
                HeightRequest="48"
                Command="{Binding CloseCommand}"
                SemanticProperties.Description="Закрыть детали заметки" />
    </Grid>
</ContentPage>
